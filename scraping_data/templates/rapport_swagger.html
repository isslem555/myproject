<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport Swagger - Endpoints</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 2rem;
            background-color: #f8f9fa;
        }
        h1 {
            margin-bottom: 2rem;
        }
        .endpoint-card {
            margin-bottom: 1.5rem;
        }
        .method {
            text-transform: uppercase;
            font-weight: bold;
            font-size: 1rem;
            padding: 0.3rem 0.7rem;
            border-radius: 0.3rem;
        }
        .GET { background-color: #198754; color: white; }
        .POST { background-color: #0d6efd; color: white; }
        .PUT { background-color: #ffc107; color: black; }
        .DELETE { background-color: #dc3545; color: white; }
        .UNKNOWN { background-color: #6c757d; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center">Rapport des Endpoints Swagger</h1>

    <!-- Bouton vers statistiques Swagger -->
    <a href="{% url 'swagger-statistiques' %}">
        <button style="background-color:#007bff;color:white;padding:10px 20px;border:none;border-radius:5px;">
            üìà Voir les statistiques Swagger
        </button>
    </a>

    <!-- Formulaire dynamique pour URL Swagger -->
    <form id="scraping-form" class="text-center mb-4">
        <input type="text" id="swagger-url" placeholder="Entrez une URL Swagger (ex: https://example.com/swagger.json)" class="form-control mb-2" style="max-width: 600px; margin: auto;">
        <button type="submit" class="btn btn-primary">üîÑ Lancer le scraping Swagger</button>
        <a href="{% url 'rapport-swagger-pdf' %}" class="btn btn-success ms-2" target="_blank">üìÑ T√©l√©charger le rapport PDF</a>
        <div id="scraping-status" class="mt-2 text-center fw-bold"></div>
    </form>

    <!-- Liste des endpoints Swagger -->
    {% if swagger_data %}
        {% for item in swagger_data %}
            <div class="card endpoint-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <span class="method {{ item.method }}">{{ item.method }}</span>
                        <code>{{ item.endpoint }}</code>
                    </h5>
                    <p class="card-text text-muted">{{ item.summary }}</p>

                    {% if item.parameters %}
                        <h6>Param√®tres :</h6>
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Nom</th>
                                    <th>In</th>
                                    <th>Requis</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for param in item.parameters %}
                                    <tr>
                                        <td>{{ param.name }}</td>
                                        <td>{{ param.in }}</td>
                                        <td>{{ param.required }}</td>
                                        <td>{{ param.type }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">Aucun param√®tre requis.</p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="alert alert-warning text-center">‚ùå Aucune donn√©e Swagger trouv√©e.</p>
    {% endif %}
</div>

<!-- Script Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Script formulaire JS -->
<script>
document.getElementById('scraping-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const url = document.getElementById('swagger-url').value;
    const statusDiv = document.getElementById('scraping-status');

    if (!url) {
        statusDiv.textContent = "‚ö†Ô∏è Veuillez entrer une URL Swagger.";
        return;
    }

    statusDiv.textContent = "‚è≥ Scraping en cours...";

    fetch("{% url 'lancer-scraping-url' %}", {
        method: "POST",
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ swagger_url: url })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "succ√®s") {
            statusDiv.textContent = "‚úÖ " + data.message;
            setTimeout(() => location.reload(), 1500);
        } else {
            statusDiv.textContent = "‚ùå " + data.message;
        }
    })
    .catch(err => {
        statusDiv.textContent = "‚ùå Erreur : " + err;
    });
});
</script>

</body>
</html>
